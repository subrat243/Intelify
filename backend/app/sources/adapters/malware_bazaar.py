from typing import List, Dict, Any
import json

from app.sources.base import RESTAdapter


class MalwareBazaarAdapter(RESTAdapter):
    """
    Adapter for MalwareBazaar by abuse.ch - Completely free.
    Provides malware file hashes (MD5, SHA256).
    
    No API key required.
    """
    
    def __init__(self, config: Dict[str, Any] = None):
        super().__init__(
            url="https://mb-api.abuse.ch/api/v1/",
            config=config or {}
        )
        self.name = "MalwareBazaar"
    
    def fetch(self) -> bytes:
        """Fetch recent malware samples from MalwareBazaar."""
        # Get recent samples (last 100)
        data = {
            "query": "get_recent",
            "selector": "100"
        }
        
        response = self.make_request(
            self.url,
            method="POST",
            data=data
        )
        
        return response.content
    
    def parse(self, raw_data: bytes) -> List[Dict[str, Any]]:
        """Parse MalwareBazaar response."""
        response_data = json.loads(raw_data)
        iocs = []
        
        if response_data.get("query_status") != "ok":
            return iocs
        
        for entry in response_data.get("data", []):
            # Add SHA256 hash
            sha256 = entry.get("sha256_hash")
            if sha256:
                ioc_sha256 = self.normalize_ioc(
                    indicator=sha256,
                    ioc_type="hash_sha256",
                    category="malware",
                    tags=["malware", entry.get("signature", "unknown")],
                    confidence_score=0.85,
                    metadata={
                        "file_name": entry.get("file_name"),
                        "file_type": entry.get("file_type"),
                        "file_size": entry.get("file_size"),
                        "signature": entry.get("signature"),
                        "first_seen": entry.get("first_seen"),
                        "delivery_method": entry.get("delivery_method")
                    }
                )
                iocs.append(ioc_sha256)
            
            # Add MD5 hash
            md5 = entry.get("md5_hash")
            if md5:
                ioc_md5 = self.normalize_ioc(
                    indicator=md5,
                    ioc_type="hash_md5",
                    category="malware",
                    tags=["malware", entry.get("signature", "unknown")],
                    confidence_score=0.85,
                    metadata={
                        "file_name": entry.get("file_name"),
                        "file_type": entry.get("file_type"),
                        "signature": entry.get("signature")
                    }
                )
                iocs.append(ioc_md5)
        
        return iocs
