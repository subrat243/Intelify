import axios from 'axios';
import { OSINTAdapter, NormalizedIndicator, IndicatorType } from './types';

export class MalwareBazaarAdapter implements OSINTAdapter {
    name = 'MalwareBazaar';
    sourceId = 'malwarebazaar';
    private baseUrl = 'https://mb-api.abuse.ch/api/v1/';

    async fetchLatest(limit: number = 20): Promise<NormalizedIndicator[]> {
        try {
            const response = await axios.post(this.baseUrl, 'query=get_recent&selector=100');

            const indicators: NormalizedIndicator[] = [];
            const samples = response.data.data || [];

            for (const entry of samples) {
                indicators.push({
                    type: 'HASH_SHA256',
                    value: entry.sha256_hash,
                    confidence: 95,
                    riskScore: 98,
                    description: `Malware payload detected: ${entry.signature || 'Generic'}. Family: ${entry.tags?.join(', ') || 'Unknown'}`,
                    tags: [...(entry.tags || []), entry.signature].filter(Boolean),
                    metadata: {
                        sha1: entry.sha1_hash,
                        md5: entry.md5_hash,
                        fileType: entry.file_type,
                        signature: entry.signature,
                        deliveryMethod: entry.delivery_method
                    }
                });
                if (indicators.length >= limit) break;
            }

            return indicators;
        } catch (error) {
            console.error('MalwareBazaar Fetch Error:', error);
            return [];
        }
    }

    async searchIndicator(value: string, type: IndicatorType): Promise<NormalizedIndicator | null> {
        if (!type.includes('HASH')) return null;
        return null;
    }
}
